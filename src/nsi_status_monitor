#
# Name: nsi_status_monitor
# Author: Anil Kumar
# Purpsose: To stop netstorm. pid is taken from lock file
#
# Usage:  nsi_stop_monitor 
# Exit Values: 0 - running, 1 - not running
# Modification History:
#   05/26/05: - Initial Version
#

protocol="http"

HttpRecordingRunning=0
OtherRecordingRunning=0

if [ "XX" = "XX$NS_WDIR" ]
then
  NS_WDIR=/home/cavisson/work
fi

LockFile=$NS_WDIR/bin/.monitor.lock
LogFile=$NS_WDIR/webapps/netstorm/logs/status_monitor.log
ErrorFile=$NS_WDIR/webapps/netstorm/logs/monitor_error.log
MonitorTraceFile=$NS_WDIR/webapps/netstorm/logs/monitor_trace.log


> $LogFile


HPDLogFile=$LogFile


msgout ()
{
	echo "$1" >>$LogFile
	echo "$1"
}

show_capture_trace()
{
   if  [ -f $MonitorTraceFile ];then
     if  [ -s $MonitorTraceFile ];then
       msgout "Capture request trace:"
       cat $MonitorTraceFile
     fi
    # else
     #   msgout "$MonitorTraceFile File is empty"
    # fi
  # else 
   #  msgout "$MonitorTraceFile File doesn't exist"
   fi
}


check_http_recording_status()
{
  cd $NS_WDIR
  if [ -f $LockFile ];then
    pid=`cat $LockFile`
    if [ -e /proc/$pid ];then
      HttpRecordingRunning=1
      #msgout "Script recording is running"
      return
      #show_capture_trace
      #exit 0
    fi
  fi

  rm -f $LockFile
  HttpRecordingRunning=0
  #At this point, script recorder (nsu_monitor) is not running
}

check_other_proto_recording_status()
{ 
  /etc/init.d/$HPD_CMD start_time 1>> $HPDLogFile 2>&1
  if [ $? != 0 ]; then
    OtherRecordingRunning=0
    return
  fi

  grep "^ENABLE_RECORDING 1" $HPD_ROOT/conf/hpd.conf 1>/dev/null
  if [ $? == 0 ]; then
    echo "Enable recording is on in $HPD_ROOT/conf/hpd.conf"
    OtherRecordingRunning=1
  else
    echo "Enable recording is off in $HPD_ROOT/conf/hpd.conf"
    OtherRecordingRunning=0
  fi

}

show_running()
{
  msgout "Script recording is running"
  exit 0
}

while getopts P: c
do
  case $c in
  P) protocol="$OPTARG";;
  ?) echo "Usage: $0 <-P protocol >"
     exit -1 ;;
  esac
done

msgout "Checking if script recorder running " #>> $LogFile

if [ "X$protocol" == "Xhttp" ]; then 
  check_http_recording_status
  if [ $HttpRecordingRunning -eq 1 ]; then
    show_running
  fi
# We should not check hpd as it will be running as we are restarting on stop recording
elif [ "X$protocol" == "Xother" ]; then
  check_other_proto_recording_status
  if [ $OtherRecordingRunning -eq 1 ]; then
    show_running
  fi
elif [ "X$protocol" == "Xboth" ]; then 
  check_http_recording_status
  check_other_proto_recording_status
  if [ $HttpRecordingRunning -eq 1 -a $OtherRecordingRunning -eq 1 ]; then
    show_running
  fi
fi

msgout "Script recordings is not running "

if [ -s $ErrorFile ];then
  echo "Following is the error:"
  cat $ErrorFile
  show_capture_trace
fi

exit 1
