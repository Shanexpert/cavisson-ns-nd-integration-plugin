#!/bin/sh

##
# Deletes scheduled netstorm entries
#
# nsu_delete_test_schedule –j <job_id> or –j ALL -f

JOBID="ALL"
jobq=""
FORCE="no"

display_help_and_exit()
{
  echo "ERROR: Incorrect usage"
  echo "Usage:"
  echo "nsu_delete_test_schedule -j <job_id> or -j ALL -f"
  echo "        -f - for forceful deletion."
  #echo "    e.g.  nsu_start_test TestScenario or nsu_start_test TestScenario -master"
  exit 1
}


id=`whoami`
# if [ $id != "netstorm" ]; then
#     echo "You can only run this command with netstorm id"
#     exit 1
# fi

while getopts j:f? c
do
    case $c in
        j) JOBID="$OPTARG"; jobq="$jobq,$OPTARG" ;;
        f) FORCE="yes" ;;
        ?) display_help_and_exit ;;
    esac
done

remove_schedule() 
{
    jobid=$1
    Scenario=$2
    time=$3

    atrm $jobid
    if [ $? == 0 ]; then
        echo -e "JobID $jid: ${Scenario} Scheduled at ${time} deleted."
    else
        echo -e "Unable to delete JobID $jid: ${Scenario} from scheduled at ${time}."
    fi
}

if [ "XX $JOBID XX" == "XX ALL XX" ]; then
    for i in `at -q n -l | awk '{print $1"|"$3"["$2"]"}'`
    do
        jid=`echo $i | cut -d"|" -f1`
        time=`echo $i | cut -d"|" -f2`
        Scenario=`at -q n -c $jid | grep nsu_start_test | awk '{print $3}'`
        
        if [ "$FORCE" == "yes" ]; then
            remove_schedule $jid $Scenario $time
        else
            echo -n "Do you want to delete JobID $jid: ${Scenario} scheduled at ${time} (y/n): "
            read y
            if [ "$y" == "y" ]; then
                remove_schedule $jid $Scenario $time
            fi
        fi
    done
else
    
    for JOBID in `echo $jobq | sed 's/,/ /g'`
    do
        i=`at -q n -l  | awk '$1 == jobid {print $1"|"$3"["$2"]"}' jobid=$JOBID`

        if [ "XX $i XX" == "XX  XX" ];then
            echo "No job with id $JOBID scheduled".
            exit 2
        fi

        jid=`echo $i | cut -d"|" -f1`
        time=`echo $i | cut -d"|" -f2`
        Scenario=`at -q n -c $jid | grep nsu_start_test | awk '{print $3}'`
        
        if [ "$FORCE" == "yes" ]; then
            remove_schedule $jid $Scenario $time
        else
            echo -n "Do you want to delete JobID $jid: ${Scenario} scheduled at ${time} (y/n): "
            read y
            if [ "$y" == "y" ]; then
                remove_schedule $jid $Scenario $time
            fi
        fi
    done
fi
