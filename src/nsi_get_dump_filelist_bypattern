# Name      : nsi_get_dump_filelist_bypattern
# Author    : Ankit Khanijau
# Purpsose  : To get the matching text from script/dump/*.
#
# Usage     :  nsi_get_dump_filelist_bypattern  -s <Script Name> -t <text> -f <flow name> -u <user_name> -p <profile_name>"
#             e.g.  nsi_get_dump_filelist_bypattern -n /default/default/abc -t xyz -f flow_name
#
# Modification History:
#   09/10/11: Ankit Khanijau - Initial Version
#
#!/bin/sh

#Check and get script name 
# -s <workspace_name>/<profile>/cavisson/<proj>/<subproj>/scripts/<script_dir>
usage() {
  echo "Example: -s <workspace_name>/<profile>/cavisson/<proj>/<subproj>/scripts/<script_dir> -t <Search Text> -f <flow name>"
  exit 1
}

  if [ $# -lt 6 ];then
    usage
    exit 1
  fi

  SCRIPT_NAME_WITH_PATH=$2
  FLOW_NAME=$6
  DUMP_NAME=""
  SCRIPT_PATH="workspace/$2"

  if [ ! -d $NS_WDIR/$SCRIPT_PATH ]; then
    echo "Script $2 does not exist"
    exit -1
  fi

  #echo "Path is '$SCRIPT_NAME_WITH_PATH'"
  #cd $NS_WDIR/scripts/$SCRIPT_NAME_WITH_PATH/dump

  #to check the existence of dump folder under $NS_WDIR/scripts/$SCRIPT_NAME_WITH_PATH
  if [ "XX$FLOW_NAME" == "XX" ];then
    DUMP_NAME="dump"
  else
    DUMP_NAME="dump/$FLOW_NAME"
    if [ ! -d $NS_WDIR/$SCRIPT_PATH/$DUMP_NAME ]; then
      echo "Script $2 does not have dump folder for the flow $FLOW_NAME"
      exit -1
    fi
  fi

  if [ -d "$NS_WDIR/$SCRIPT_PATH/$DUMP_NAME" ]; then
    cd $NS_WDIR/$NS_RTA_DIR/$SCRIPT_PATH/$DUMP_NAME
    #FileList=`grep -rl $4 * | grep -v headers/page | grep -v $4 | grep -v url_info.list`
    #Note - -F option is passed so that regular express is not used in grep
    #For example, if we use entryFormList[0].sku, it will not work without -F as [] is for regualar expression
    #   nsi_get_dump_filelist_bypattern -s OfficeDepot/Demo/OfficeDepotAnil -t "entryFormList[0].sku"
    FileList=`ls -1 | egrep -v "index|url_info.list|pagesList.html|headers" | xargs grep -rl -F -- "$4"`

    if [ "XX$FileList" != "XX" ];then
      echo "$FileList"
      exit 0
    else
      echo "Error: Search text is not found in any web url response" 
      exit -1
    fi 
  else
    echo "Dump folder is not present in this Script - '$NS_WDIR/scripts/$SCRIPT_NAME_WITH_PATH'"
    exit -1
  fi

