#!/bin/bash
SCRIPT_NAME=""
PROJ_SUBPROJ=""
SCHEMA_FILE=""
TOOL_PATH="/home/cavisson/thirdparty/.script_lib/avro-tools-1.10.0.jar"


#(ls /home/cavisson/thirdparty/.script_lib/avro-tools-1.10.0.jar >> /dev/null 2>&1 && echo yes) || echo no


checkArgs()
{
 if [[ "X$SCRIPT_NAME" = "X"  || "X$PROJ_SUBPROJ" = "X" || "X$SCHEMA_FILE" = "X" ]];
 then
    echo "usage:  nsu_gen_avro_schema_file -s <scriptname> -p <proj/subproj> -f <schema_file>"
    exit 0
 fi
}



while getopts s:p:f:? c 2>/dev/null
do
  case $c in
    s) SCRIPT_NAME=$OPTARG;;
    p) PROJ_SUBPROJ=$OPTARG;;
    f) SCHEMA_FILE=$OPTARG;;
    ?) checkArgs ;;
    *) checkArgs ;;
  esac
done

checkArgs

toolExist=$(!(ls ${TOOL_PATH} >> /dev/null 2>&1) && echo no)
# || echo no

if [ $toolExist ]; then
   echo "Error: Avro tool not exist!"
   exit 0
fi

mkdir -p avro_schema
java -jar /home/cavisson/thirdparty/.script_lib/avro-tools-1.10.0.jar compile schema /tmp/$SCHEMA_FILE /tmp/avro_schema/ 2>/tmp/err.txt

if [ $? -ne 0 ];then
   cat /tmp/err.txt | sed 1,2d /tmp/err.txt 
    exit 0
fi

cp /tmp/avro_schema/com/cavisson/scripts/${SCRIPT_NAME}/*.java $NS_WDIR/webapps/scripts/${PROJ_SUBPROJ}/${SCRIPT_NAME} 2>/dev/null
if [ `echo $?` == "1" ];then
  echo "Error: Namespace should be same as script!"
  exit 0
fi

echo "List of generated files,"$(ls --format=commas "/tmp/avro_schema/com/cavisson/scripts/$SCRIPT_NAME/")
#ls --format=commas /tmp/avro_schema/com/cavisson/scripts/$script_name/
rm -rf /tmp/avro_schema/
